
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NET-METERING SIMULATOR for Electric Cooperatives</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
            color: #1e293b;
        }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
        }

        .input-group label {
            display: block;
            font-size: 0.65rem;
            font-weight: 800;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.35rem;
        }

        .input-group input {
            width: 100%;
            padding: 0.6rem 0.8rem;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            outline: none;
            transition: all 0.2s ease;
            background: #fdfdfd;
        }

        .input-group input:focus {
            border-color: #2563eb;
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
        }

        .tab-btn {
            padding: 0.6rem 1.2rem;
            font-weight: 700;
            font-size: 0.8rem;
            border-radius: 8px;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .tab-btn.active {
            background: #1e293b;
            color: white;
        }

        .meralco-table {
            width: 100%;
            border-collapse: collapse;
        }

        .meralco-table th {
            font-size: 0.65rem;
            font-weight: 900;
            color: #64748b;
            text-transform: uppercase;
            border-bottom: 2px solid #f1f5f9;
            padding: 0.75rem 0.5rem;
            text-align: right;
        }

        .meralco-table th:first-child {
            text-align: left;
        }

        .meralco-table td {
            font-size: 0.75rem;
            padding: 0.5rem;
            border-bottom: 1px solid #f8fafc;
            color: #475569;
            text-align: right;
        }

        .meralco-table td:first-child {
            text-align: left;
        }

        .section-header-row td {
            background-color: #f8fafc;
            font-weight: 800;
            color: #1e293b;
            font-size: 0.8rem;
        }

        .export-row-standard {
            background-color: #ecfdf5 !important;
            color: #065f46 !important;
            font-weight: 900 !important;
            border-left: 4px solid #10b981 !important;
        }

        .export-row-standard td {
            color: #065f46 !important;
            border-bottom-color: #d1fae5 !important;
        }

        .actual-kwh-highlight {
            background: #eff6ff;
            border-left: 4px solid #2563eb;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
            border-radius: 0 12px 12px 0;
        }

        .badge-rejected {
            background: #fee2e2;
            color: #b91c1c;
            border: 1px solid #fecaca;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 800;
        }

        .permit-item {
            border-left: 2px solid #e2e8f0;
            padding-left: 1rem;
            margin-bottom: 1.5rem;
        }

        .advisory-box {
            background: #fffbeb;
            border: 1px solid #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
        }

        .info-pill {
            font-size: 9px;
            font-weight: 800;
            padding: 2px 6px;
            border-radius: 4px;
            display: inline-block;
            margin-bottom: 4px;
        }

        .gov-sub-header {
            font-size: 11px;
            font-weight: 900;
            color: #1e293b;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 1rem;
            display: block;
            border-left: 3px solid #3b82f6;
            padding-left: 0.75rem;
        }

        .roadmap-step {
            position: relative;
            padding-left: 2.5rem;
            border-left: 2px solid #e2e8f0;
            padding-bottom: 2rem;
        }

        .roadmap-step:last-child {
            border-left-color: transparent;
            padding-bottom: 0;
        }

        .roadmap-step::before {
            content: '';
            position: absolute;
            left: -10px;
            top: 0;
            height: 18px;
            width: 18px;
            background: white;
            border: 3px solid #3b82f6;
            border-radius: 9999px;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 1rem;
        }

        .comp-col {
            @apply p-4 rounded-xl border border-slate-100 flex flex-col;
        }

        .comp-label {
            @apply text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1;
        }

        .comp-val {
            @apply text-base font-black text-slate-900;
        }

        .gov-card {
            @apply bg-white p-6 rounded-xl border border-slate-200 shadow-sm;
        }

        .gov-title {
            @apply text-lg font-black text-slate-800 uppercase tracking-tight mb-4 flex items-center gap-2;
        }

        .gov-text {
            @apply text-xs leading-relaxed text-slate-600 mb-4;
        }

        .gov-list {
            @apply list-none space-y-2 mt-4;
        }

        .gov-list li {
            @apply text-xs text-slate-600 flex items-start gap-2;
        }

        .gov-list li::before {
            content: '•';
            @apply text-blue-500 font-bold;
        }

        /* Styles for Editable Inputs in Table */
        .table-input {
            width: 100%;
            max-width: 80px;
            background: transparent;
            border-bottom: 1px dashed #cbd5e1;
            text-align: right;
            font-weight: 700;
            color: #475569;
            outline: none;
            padding: 2px 0;
            transition: all 0.2s;
        }

        .table-input:focus {
            border-bottom: 2px solid #2563eb;
            color: #1e293b;
        }

        .table-input.pct-input {
            max-width: 50px;
        }

        /* Print formatting */
        @media print {
            body {
                background: white !important;
                padding: 0 !important;
            }

            .no-print {
                display: none !important;
            }

            .card {
                border: 1px solid #eee !important;
                box-shadow: none !important;
                margin-bottom: 20px !important;
                break-inside: avoid;
            }

            .max-w-7xl {
                width: 100% !important;
                max-width: 100% !important;
                margin: 0 !important;
            }

            #tab-bill-content,
            #tab-analytics-content {
                display: block !important;
            }

            .lg\:col-span-3 {
                display: none !important;
            }

            .lg\:col-span-9,
            .lg\:col-span-12 {
                width: 100% !important;
            }

            .actual-kwh-highlight {
                border: 1px solid #blue-200 !important;
            }

            .meralco-table th,
            .meralco-table td {
                font-size: 10px !important;
            }

            .pricing-hero {
                font-size: 48px !important;
            }

            .table-input {
                border: none !important;
                text-align: right;
                padding: 0;
            }
        }
    </style>
</head>

<body class="p-4 lg:p-8" id="main-body">

    <div class="max-w-7xl mx-auto space-y-6">

        <!-- Header -->
        <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4 no-print">
            <div>
                <h1 class="text-3xl font-black text-slate-900 tracking-tight italic uppercase">NET-METERING <span
                        class="not-italic text-slate-500 font-medium tracking-normal">SIMULATOR for Electric
                        Cooperatives</span></h1>
                <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mt-1">
                    Dec 2025 Schedule • Electric Cooperative Rate
                </p>
            </div>
            <div class="flex flex-wrap gap-2">
                <div class="flex bg-white p-1 rounded-xl shadow-sm border border-slate-200 overflow-x-auto">
                    <button onclick="switchTab('bill')" id="btn-bill" class="tab-btn active">Coop Bill</button>
                    <button onclick="switchTab('analytics-coop')" id="btn-analytics-coop"
                        class="tab-btn text-slate-500">Coop Analytics</button>
                    <div class="w-px h-6 bg-slate-200 self-center mx-1"></div>
                    <button onclick="switchTab('meralco')" id="btn-meralco" class="tab-btn text-slate-500">Meralco
                        Bill</button>
                    <button onclick="switchTab('analytics-meralco')" id="btn-analytics-meralco"
                        class="tab-btn text-slate-500">Meralco Analytics</button>
                </div>
                <!-- Print Button Removed -->
            </div>
        </div>

        <!-- TAB: COOP BILLING SIMULATOR -->
        <div id="tab-bill-content" class="grid grid-cols-1 lg:grid-cols-12 gap-6 items-start">
            <div class="lg:col-span-3 space-y-4 no-print">
                <div class="card p-5 bg-slate-50/50">
                    <h2 class="text-[10px] font-black text-slate-900 mb-4 uppercase tracking-widest">Input Parameters
                    </h2>
                    <div class="space-y-3">
                        <div class="input-group">
                            <label>Solar PV Capacity (kWp)</label>
                            <input type="number" id="derCapacityKWp" value="5" max="100"
                                oninput="validateAndCalculate()">
                            <p class="text-[8px] text-red-500 font-bold mt-1 hidden" id="cap-warning">Max capacity is
                                100 kWp</p>
                        </div>
                        <div class="input-group">
                            <label>Solar Capacity Factor (%)</label>
                            <input type="number" id="capacityFactor" value="18" step="0.1" oninput="calculateBill()">
                        </div>
                        <div class="input-group">
                            <label>Grid Import (kWh)</label>
                            <input type="number" id="importKwh" value="329" oninput="calculateBill()">
                        </div>
                        <div class="input-group">
                            <label class="flex flex-col">
                                <span class="flex justify-between items-center">
                                    Solar Export (kWh)
                                </span>
                                <span class="text-[8px] text-slate-400 normal-case font-bold mt-1">Exported energy is
                                    credited at Generation Rate.</span>
                            </label>
                            <input type="number" id="exportKwh" value="731" oninput="calculateBill()">
                        </div>
                        <div class="input-group hidden">
                            <label>Billed Demand (kW)</label>
                            <input type="number" id="demandKw" value="0" oninput="calculateBill()">
                        </div>
                        <div class="input-group">
                            <label>Power Factor (%)</label>
                            <input type="number" id="powerFactor" value="98.84" step="0.01" oninput="calculateBill()">
                        </div>
                    </div>
                </div>

                <div id="sideStatusCard"
                    class="card p-5 bg-slate-900 text-white shadow-lg transition-colors duration-300">
                    <div class="flex justify-between items-start mb-1">
                        <p class="text-[10px] font-black uppercase opacity-60 tracking-widest">Amount Payable</p>
                        <span id="sideRejectionBadge" class="hidden badge-rejected uppercase">CAPPED</span>
                    </div>
                    <h2 class="text-3xl font-black tracking-tighter" id="sideTotal">₱ 0.00</h2>
                    <div id="rollover-box"
                        class="hidden mt-2 p-2 bg-emerald-900/50 border border-emerald-500/30 rounded text-emerald-400">
                        <p class="text-[8px] font-black uppercase">Rollover Credit</p>
                        <p class="text-sm font-black" id="sideRollover">₱ 0.00</p>
                    </div>
                    <div class="mt-4 pt-4 border-t border-white/10">
                        <p class="text-[9px] font-bold uppercase opacity-60 text-emerald-400">REC Meter Mandatory</p>
                        <p class="text-[8px] font-bold uppercase opacity-50">No DSM Charges Applied</p>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-9 space-y-6">
                <!-- Actual Consumption Breakdown -->
                <div class="actual-kwh-highlight" id="actual-cons-box">
                    <div class="flex justify-between items-start mb-3">
                        <h3 class="text-xs font-black text-blue-900 uppercase tracking-widest">Monthly Energy Balance
                            (kWh)</h3>
                        <span
                            class="text-[9px] font-black bg-blue-600 text-white px-2 py-0.5 rounded uppercase tracking-tighter">Net-Metering
                            Summary</span>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-center mb-4 text-center md:text-left">
                        <div class="bg-white p-3 rounded-lg border border-blue-100">
                            <p class="text-[9px] text-slate-400 font-black uppercase mb-1">Grid Import</p>
                            <p class="text-lg font-bold text-slate-800" id="math-import">97,800</p>
                        </div>
                        <div class="font-bold text-blue-400 italic text-center">minus</div>
                        <div class="bg-white p-3 rounded-lg border border-blue-100">
                            <p class="text-[9px] text-slate-400 font-black uppercase mb-1">Solar Export</p>
                            <p class="text-lg font-bold text-slate-800" id="math-export">5,000</p>
                        </div>
                        <div class="font-bold text-blue-400 md:hidden text-center">plus</div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-center text-center md:text-left">
                        <div class="bg-white p-3 rounded-lg border border-blue-100">
                            <p class="text-[9px] text-slate-400 font-black uppercase mb-1">Solar Generated</p>
                            <p class="text-lg font-bold text-slate-800" id="math-gen">60,264</p>
                        </div>
                        <div class="font-bold text-blue-400 italic text-center">equals</div>
                        <div class="bg-blue-600 p-3 rounded-lg col-span-1 md:col-span-2 shadow-sm">
                            <p class="text-[9px] text-blue-100 font-black uppercase mb-1">Total Billing Base (Subsidies
                                Multiplier)</p>
                            <p class="text-xl font-black text-white" id="math-actual">153,064 kWh</p>
                        </div>
                    </div>
                </div>

                <div class="card overflow-hidden">
                    <div class="bg-slate-50 border-b border-slate-100 p-8 flex justify-between items-center">
                        <h2 class="text-base font-black text-slate-800 uppercase tracking-tight">Statement Details</h2>
                        <div class="flex items-center gap-6">
                            <div class="text-right">
                                <p
                                    class="text-[8px] font-black text-slate-400 uppercase tracking-widest mb-1 text-right">
                                    Net billing Base</p>
                                <span class="text-6xl font-black text-slate-900 italic block pricing-hero"
                                    id="tierDisp">NM</span>
                            </div>
                        </div>
                    </div>

                    <div class="p-2 overflow-x-auto">
                        <table class="meralco-table">
                            <thead>
                                <tr>
                                    <th class="text-left">Description</th>
                                    <th>Base</th>
                                    <th>Price (Editable)</th>
                                    <th>Amount (PhP)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Generation & Transmission -->
                                <tr class="section-header-row">
                                    <td colspan="3">Generation & Transmission</td>
                                    <td id="det-gen-trans-total">0.00</td>
                                </tr>
                                <tr>
                                    <td>Generation System Charge</td>
                                    <td id="li-gen-base">--</td>
                                    <td><input type="number" id="rate-gen" value="5.8118" step="0.0001"
                                            class="table-input" oninput="calculateBill()"></td>
                                    <td id="li-gen-amt">0.00</td>
                                </tr>
                                <tr>
                                    <td>Benefits to Host Communities</td>
                                    <td id="li-host-base">--</td>
                                    <td><input type="number" id="rate-host" value="0.0282" step="0.0001"
                                            class="table-input" oninput="calculateBill()"></td>
                                    <td id="li-host-amt">0.00</td>
                                </tr>
                                <tr>
                                    <td>Power Act Reduction</td>
                                    <td id="li-power-base">--</td>
                                    <td><input type="number" id="rate-poweract" value="-0.1052" step="0.0001"
                                            class="table-input" oninput="calculateBill()"></td>
                                    <td id="li-power-amt">0.00</td>
                                </tr>
                                <tr>
                                    <td>Transmission Demand Charge</td>
                                    <td id="li-trans-demand-base">--</td>
                                    <td><input type="number" id="rate-trans-demand" value="0.0000" step="0.0001"
                                            class="table-input" oninput="calculateBill()"></td>
                                    <td id="li-trans-demand-amt">0.00</td>
                                </tr>
                                <tr>
                                    <td>Transmission System Charge</td>
                                    <td id="li-trans-base">--</td>
                                    <td><input type="number" id="rate-trans" value="1.3561" step="0.0001"
                                            class="table-input" oninput="calculateBill()"></td>
                                    <td id="li-trans-amt">0.00</td>
                                </tr>
                                <tr>
                                    <td>System Loss Charge</td>
                                    <td id="li-sl-base">--</td>
                                    <td><input type="number" id="rate-sl" value="0.7319" step="0.0001"
                                            class="table-input" oninput="calculateBill()"></td>
                                    <td id="li-sl-amt">0.00</td>
                                </tr>

                                <!-- Distribution -->
                                <tr class="section-header-row">
                                    <td colspan="3">Distribution</td>
                                    <td id="det-dist-total">0.00</td>
                                </tr>
                                <tr>
                                    <td>Distribution System Charge</td>
                                    <td id="li-dist-energy-base">--</td>
                                    <td><input type="number" id="rate-dist-energy" value="0.4613" step="0.0001"
                                            class="table-input" oninput="calculateBill()"></td>
                                    <td id="li-dist-energy-amt">0.00</td>
                                </tr>
                                <tr>
                                    <td>Distribution Demand Charge</td>
                                    <td id="li-dist-demand-base">--</td>
                                    <td><input type="number" id="rate-dist-demand" value="0.0000" step="0.0001"
                                            class="table-input" oninput="calculateBill()"></td>
                                    <td id="li-dist-demand-amt">0.00</td>
                                </tr>
                                <tr>
                                    <td>Supply System Charge</td>
                                    <td id="li-supply-base">--</td>
                                    <td><input type="number" id="rate-supply" value="0.5376" step="0.0001"
                                            class="table-input" oninput="calculateBill()"></td>
                                    <td id="li-supply-amt">0.00</td>
                                </tr>
                                <tr>
                                    <td>Supply Retail Customer Charge</td>
                                    <td>1.00 mo</td>
                                    <td><input type="number" id="rate-supply-fix" value="0.0000" step="0.01"
                                            class="table-input" oninput="calculateBill()"></td>
                                    <td id="disp-supply-fix">0.00</td>
                                </tr>
                                <tr>
                                    <td>Metering System Charge</td>
                                    <td id="li-metering-base">--</td>
                                    <td><input type="number" id="rate-metering" value="0.3205" step="0.0001"
                                            class="table-input" oninput="calculateBill()"></td>
                                    <td id="li-metering-amt">0.00</td>
                                </tr>
                                <tr>
                                    <td>Metering Retail Customer Charge</td>
                                    <td>1.00 mo</td>
                                    <td><input type="number" id="rate-metering-fix" value="5.0000" step="0.01"
                                            class="table-input" oninput="calculateBill()"></td>
                                    <td id="disp-metering-fix">5.00</td>
                                </tr>
                                <tr>
                                    <td>Reinvestment Fund for Sustainable CapEx</td>
                                    <td id="li-reinvest-base">--</td>
                                    <td><input type="number" id="rate-reinvest" value="0.2178" step="0.0001"
                                            class="table-input" oninput="calculateBill()"></td>
                                    <td id="li-reinvest-amt">0.00</td>
                                </tr>

                                <!-- Subsidy & Discount -->
                                <tr class="section-header-row">
                                    <td colspan="3">Subsidy & Discount</td>
                                    <td id="det-subs-total">0.00</td>
                                </tr>
                                <tr>
                                    <td>Lifeline Rate Subsidy/Discount</td>
                                    <td id="li-life-base">--</td>
                                    <td><input type="number" id="rate-life" value="0.0036" step="0.0001"
                                            class="table-input" oninput="calculateBill()"></td>
                                    <td id="li-life-amt">0.00</td>
                                </tr>
                                <tr>
                                    <td>Senior Citizen Subsidy/Discount</td>
                                    <td id="li-senior-base">--</td>
                                    <td><input type="number" id="rate-senior" value="0.0005" step="0.0001"
                                            class="table-input" oninput="calculateBill()"></td>
                                    <td id="li-senior-amt">0.00</td>
                                </tr>

                                <!-- Local Taxes -->
                                <tr class="section-header-row">
                                    <td colspan="3">Local Taxes</td>
                                    <td id="det-tax-total">0.00</td>
                                </tr>
                                <tr>
                                    <td>Local Franchise Tax Energy Charge</td>
                                    <td id="li-lft-energy-base">--</td>
                                    <td><input type="number" id="rate-lft-energy" value="0.0000" step="0.0001"
                                            class="table-input" oninput="calculateBill()"></td>
                                    <td id="li-lft-energy-amt">0.00</td>
                                </tr>
                                <tr>
                                    <td>Local Franchise Tax Demand Charge</td>
                                    <td id="li-lft-demand-base">--</td>
                                    <td><input type="number" id="rate-lft-demand" value="0.0000" step="0.0001"
                                            class="table-input" oninput="calculateBill()"></td>
                                    <td id="li-lft-demand-amt">0.00</td>
                                </tr>
                                <tr>
                                    <td>Local Franchise Tax Fixed Monthly Charge</td>
                                    <td>1.00 mo</td>
                                    <td><input type="number" id="rate-lft-fix" value="0.0000" step="0.0001"
                                            class="table-input" oninput="calculateBill()"></td>
                                    <td id="li-lft-fix-amt">0.00</td>
                                </tr>
                                <tr>
                                    <td>Business Tax</td>
                                    <td id="li-bus-tax-base">--</td>
                                    <td><input type="number" id="rate-bus-tax" value="0.0000" step="0.0001"
                                            class="table-input" oninput="calculateBill()"></td>
                                    <td id="li-bus-tax-amt">0.00</td>
                                </tr>
                                <tr>
                                    <td>Real Property Tax</td>
                                    <td id="li-rpt-base">--</td>
                                    <td><input type="number" id="rate-rpt" value="0.0066" step="0.0001"
                                            class="table-input" oninput="calculateBill()"></td>
                                    <td id="li-rpt-amt">0.00</td>
                                </tr>

                                <!-- Value Added Tax -->
                                <tr class="section-header-row">
                                    <td colspan="3">Value Added Tax</td>
                                    <td id="det-vat-total">0.00</td>
                                </tr>
                                <tr>
                                    <td>Generation VAT</td>
                                    <td id="li-gen-vat-base">--</td>
                                    <td><input type="number" id="rate-gen-vat" value="0.3595" step="0.0001"
                                            class="table-input" oninput="calculateBill()"></td>
                                    <td id="li-gen-vat-amt">0.00</td>
                                </tr>
                                <tr>
                                    <td>Transmission VAT</td>
                                    <td id="li-trans-vat-base">--</td>
                                    <td><input type="number" id="rate-trans-vat" value="0.1580" step="0.0001"
                                            class="table-input" oninput="calculateBill()"></td>
                                    <td id="li-trans-vat-amt">0.00</td>
                                </tr>
                                <tr>
                                    <td>System Loss VAT</td>
                                    <td id="li-sl-vat-base">--</td>
                                    <td><input type="number" id="rate-sl-vat" value="0.0512" step="0.0001"
                                            class="table-input" oninput="calculateBill()"></td>
                                    <td id="li-sl-vat-amt">0.00</td>
                                </tr>
                                <tr>
                                    <td>Distribution VAT (Energy)</td>
                                    <td id="li-dist-vat-kwh-base">--</td>
                                    <td><input type="number" id="rate-dist-vat-kwh" value="0.1457" step="0.0001"
                                            class="table-input" oninput="calculateBill()"></td>
                                    <td id="li-dist-vat-kwh-amt">0.00</td>
                                </tr>
                                <tr>
                                    <td>Distribution VAT (Fixed)</td>
                                    <td>1.00 mo</td>
                                    <td><input type="number" id="rate-dist-vat-fix" value="0.6000" step="0.0001"
                                            class="table-input" oninput="calculateBill()"></td>
                                    <td id="li-dist-vat-fix-amt">0.00</td>
                                </tr>
                                <tr>
                                    <td>Subsidy VAT (Lifeline & Senior Citizen)</td>
                                    <td id="li-subs-vat-base">--</td>
                                    <td><input type="number" id="rate-subs-vat" value="0.0005" step="0.0001"
                                            class="table-input" oninput="calculateBill()"></td>
                                    <td id="li-subs-vat-amt">0.00</td>
                                </tr>

                                <!-- Universal Charges -->
                                <tr class="section-header-row">
                                    <td colspan="3">Universal Charges</td>
                                    <td id="det-uc-total">0.00</td>
                                </tr>
                                <tr>
                                    <td>NPC Stranded Debts</td>
                                    <td id="li-uc-sd-base">--</td>
                                    <td><input type="number" id="rate-uc-sd" value="0.0428" step="0.0001"
                                            class="table-input" oninput="calculateBill()"></td>
                                    <td id="li-uc-sd-amt">0.00</td>
                                </tr>
                                <tr>
                                    <td>Missionary Electrification Charge - SPUG</td>
                                    <td id="li-uc-spug-base">--</td>
                                    <td><input type="number" id="rate-uc-spug" value="0.1949" step="0.0001"
                                            class="table-input" oninput="calculateBill()"></td>
                                    <td id="li-uc-spug-amt">0.00</td>
                                </tr>
                                <tr>
                                    <td>Missionary Electrification Charge - REDCI</td>
                                    <td id="li-uc-redci-base">--</td>
                                    <td><input type="number" id="rate-uc-redci" value="0.0044" step="0.0001"
                                            class="table-input" oninput="calculateBill()"></td>
                                    <td id="li-uc-redci-amt">0.00</td>
                                </tr>
                                <tr>
                                    <td>Environmental Share/Charge</td>
                                    <td id="li-uc-env-base">--</td>
                                    <td><input type="number" id="rate-uc-env" value="0.0025" step="0.0001"
                                            class="table-input" oninput="calculateBill()"></td>
                                    <td id="li-uc-env-amt">0.00</td>
                                </tr>
                                <tr>
                                    <td>FIT - All (Renewable)</td>
                                    <td id="li-fit-base">--</td>
                                    <td><input type="number" id="rate-fit" value="0.2073" step="0.0001"
                                            class="table-input" oninput="calculateBill()"></td>
                                    <td id="li-fit-amt">0.00</td>
                                </tr>
                                <tr>
                                    <td>GEA - All (Green Energy)</td>
                                    <td id="li-gea-base">--</td>
                                    <td><input type="number" id="rate-gea" value="0.0371" step="0.0001"
                                            class="table-input" oninput="calculateBill()"></td>
                                    <td id="li-gea-amt">0.00</td>
                                </tr>

                                <!-- Others -->
                                <tr class="section-header-row">
                                    <td colspan="3">Others</td>
                                    <td id="det-others-total">0.00</td>
                                </tr>

                                <!-- Exported Energy -->
                                <tr id="li-export-row" class="export-row-standard transition-all duration-300">
                                    <td id="li-export-label" class="uppercase tracking-widest py-4 font-black">
                                        Net-Metering Credits
                                        <div
                                            class="text-[8px] font-medium text-slate-400 normal-case tracking-normal mt-1 leading-tight italic">
                                            *Calculated using the previous month's blended generation rate.
                                        </div>
                                    </td>
                                    <td id="li-export-base" class="py-4 font-bold">--</td>
                                    <td id="li-export-price" class="py-4 font-bold">--</td>
                                    <td id="det-der-credit" class="py-4 font-black text-emerald-800 text-lg">- 0.00</td>
                                </tr>
                                <tr id="li-excess-row"
                                    class="hidden text-[10px] text-rose-600 font-bold bg-rose-50 border-t border-rose-100">
                                    <td class="py-2">Surplus Export Volume (Beyond 30% Cap - Not Paid)</td>
                                    <td id="li-excess-base" class="py-2">--</td>
                                    <td class="py-2">0.0000</td>
                                    <td class="py-2">0.00</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div
                        class="bg-slate-900 p-8 text-white grid grid-cols-1 md:grid-cols-2 gap-8 border-t border-white/10">
                        <div class="space-y-1 opacity-80">
                            <div class="flex justify-between text-[10px] font-black uppercase"><span>Gross Energy
                                    Amount:</span> <span id="footer-gross">0.00</span></div>
                            <div class="flex justify-between text-[10px] font-black uppercase text-emerald-400">
                                <span>Applied Export Credit:</span> <span id="footer-export">- 0.00</span>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Final Net
                                Amount Payable</p>
                            <p class="text-5xl font-black tracking-tighter text-white" id="footer-total">₱ 0.00</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: MERALCO BILLING SIMULATOR -->
        <div id="tab-meralco-content" class="hidden grid grid-cols-1 lg:grid-cols-12 gap-6 items-start">
            <div class="lg:col-span-3 space-y-4 no-print">
                <div class="card p-5 bg-orange-50/50 border-orange-100">
                    <h2 class="text-[10px] font-black text-orange-900 mb-4 uppercase tracking-widest">Meralco Parameters
                    </h2>
                    <div class="space-y-3">
                        <div class="input-group">
                            <label>Customer Class</label>
                            <select id="meralco-class" class="w-full p-2 border rounded-md text-xs font-bold"
                                onchange="calculateMeralcoBill()">
                                <option value="residential">Residential</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>Solar PV Capacity (kWp)</label>
                            <input type="number" id="m-derCapacity" value="5" step="0.1"
                                oninput="calculateMeralcoBill()">
                        </div>
                        <div class="input-group">
                            <label>Solar Capacity Factor (%)</label>
                            <input type="number" id="m-cf" value="18" step="0.1" oninput="calculateMeralcoBill()">
                        </div>
                        <div class="input-group">
                            <label>Grid Import (kWh)</label>
                            <input type="number" id="m-import" value="1075" oninput="calculateMeralcoBill()">
                        </div>
                        <div class="input-group">
                            <label>Solar Export (kWh)</label>
                            <input type="number" id="m-export" value="431" oninput="calculateMeralcoBill()">
                        </div>
                        <div class="input-group">
                            <label>LGU Franchise Tax (%)</label>
                            <input type="number" id="m-lft-rate" value="0.6270" step="0.0001"
                                oninput="calculateMeralcoBill()">
                        </div>
                    </div>
                </div>

                <div class="card p-5 bg-slate-900 text-white shadow-lg">
                    <p class="text-[10px] font-black uppercase opacity-60 tracking-widest">Total Amount Due</p>
                    <h2 class="text-3xl font-black tracking-tighter" id="m-total-due">₱ 0.00</h2>
                    <div class="mt-4 pt-4 border-t border-white/10">
                        <p class="text-[9px] font-bold uppercase text-orange-400">MERALCO NM Layout</p>
                        <p class="text-[8px] font-bold uppercase opacity-50">Effective Jan 2026 Rates</p>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-9 space-y-6">
                <!-- Meralco Styled Bill -->
                <div class="card bg-white p-0 overflow-hidden border-slate-300 shadow-xl">
                    <div class="bg-white p-6 border-b border-slate-200">
                        <div class="flex justify-between items-start">
                            <div class="flex items-center gap-3">
                                <div
                                    class="w-12 h-12 bg-orange-600 rounded-full flex items-center justify-center text-white font-black text-xl italic">
                                    M</div>
                                <div>
                                    <h2 class="text-lg font-black text-slate-900 uppercase">Meralco Net-Metering</h2>
                                    <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Bill
                                        Simulation • Jan 2026 Rates</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <span
                                    class="bg-orange-100 text-orange-700 text-[10px] font-black px-3 py-1 rounded-full uppercase">Net-Metering
                                    Service</span>
                            </div>
                        </div>
                    </div>

                    <div class="p-0">
                        <table class="meralco-table w-full">
                            <thead>
                                <tr class="bg-slate-50">
                                    <th class="p-4 text-left">Rate Components</th>
                                    <th class="p-4 text-center">Base</th>
                                    <th class="p-4 text-center">Price</th>
                                    <th class="p-4 text-right">Amount (PhP)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Generation -->
                                <tr class="section-header-row">
                                    <td class="p-3">Generation <span id="m-gen-pct"
                                            class="text-[10px] font-medium ml-2 opacity-60 text-white"></span></td>
                                    <td colspan="2"></td>
                                    <td class="p-3 text-right" id="m-gen-total">0.00</td>
                                </tr>
                                <tr>
                                    <td class="pl-8 py-2">Generation Charge (PhP/kWh)</td>
                                    <td class="text-center" id="m-gen-base">--</td>
                                    <td class="text-center"><input type="number" id="m-rate-gen" value="7.7471"
                                            step="0.0001" class="table-input w-24 text-center"
                                            oninput="calculateMeralcoBill()"></td>
                                    <td class="text-right" id="m-gen-amt">0.00</td>
                                </tr>

                                <!-- Transmission -->
                                <tr class="section-header-row">
                                    <td class="p-3">Transmission <span id="m-trans-pct"
                                            class="text-[10px] font-medium ml-2 opacity-60 text-white"></span></td>
                                    <td colspan="2"></td>
                                    <td class="p-3 text-right" id="m-trans-total">0.00</td>
                                </tr>
                                <tr>
                                    <td class="pl-8 py-2">Transmission Charge (PhP/kWh)</td>
                                    <td class="text-center" id="m-trans-base">--</td>
                                    <td class="text-center"><input type="number" id="m-rate-trans" value="1.0568"
                                            step="0.0001" class="table-input w-24 text-center"
                                            oninput="calculateMeralcoBill()"></td>
                                    <td class="text-right" id="m-trans-amt">0.00</td>
                                </tr>

                                <!-- System Loss -->
                                <tr class="section-header-row">
                                    <td class="p-3">System Loss <span id="m-sl-pct"
                                            class="text-[10px] font-medium ml-2 opacity-60 text-white"></span></td>
                                    <td colspan="2"></td>
                                    <td class="p-3 text-right" id="m-sl-total">0.00</td>
                                </tr>
                                <tr>
                                    <td class="pl-8 py-2">System Loss Charge (PhP/kWh)</td>
                                    <td class="text-center" id="m-sl-base">--</td>
                                    <td class="text-center"><input type="number" id="m-rate-sl" value="0.6932"
                                            step="0.0001" class="table-input w-24 text-center"
                                            oninput="calculateMeralcoBill()"></td>
                                    <td class="text-right" id="m-sl-amt">0.00</td>
                                </tr>

                                <!-- Distribution -->
                                <tr class="section-header-row">
                                    <td class="p-3">Distribution (Meralco) <span id="m-dist-pct"
                                            class="text-[10px] font-medium ml-2 opacity-60 text-white"></span></td>
                                    <td colspan="2"></td>
                                    <td class="p-3 text-right" id="m-dist-total">0.00</td>
                                </tr>
                                <tr>
                                    <td class="pl-8 py-2">Distribution Charge (PhP/kWh)</td>
                                    <td class="text-center" id="m-dist-base">--</td>
                                    <td class="text-center" id="m-dist-price">--</td>
                                    <td class="text-right" id="m-dist-amt">0.00</td>
                                </tr>
                                <tr>
                                    <td class="pl-8 py-2 font-bold text-[10px] uppercase">Metering Charge</td>
                                    <td colspan="3"></td>
                                </tr>
                                <tr>
                                    <td class="pl-12 py-1">Fixed Metering Charge (PhP/mo)</td>
                                    <td class="text-center">1.00 mo</td>
                                    <td class="text-center"><input type="number" id="m-rate-metering-fix" value="5.0000"
                                            step="0.0001" class="table-input w-24 text-center"
                                            oninput="calculateMeralcoBill()"></td>
                                    <td class="text-right">5.00</td>
                                </tr>
                                <tr>
                                    <td class="pl-12 py-1">Metering Charge per kWh</td>
                                    <td class="text-center" id="m-meter-base">--</td>
                                    <td class="text-center"><input type="number" id="m-rate-metering-kwh" value="0.3350"
                                            step="0.0001" class="table-input w-24 text-center"
                                            oninput="calculateMeralcoBill()"></td>
                                    <td class="text-right" id="m-meter-amt">0.00</td>
                                </tr>
                                <tr>
                                    <td class="pl-8 py-2 font-bold text-[10px] uppercase">Supply Charge</td>
                                    <td colspan="3"></td>
                                </tr>
                                <tr>
                                    <td class="pl-12 py-1">Fixed Supply Charge (PhP/mo)</td>
                                    <td class="text-center">1.00 mo</td>
                                    <td class="text-center"><input type="number" id="m-rate-supply-fix" value="16.3800"
                                            step="0.0001" class="table-input w-24 text-center"
                                            oninput="calculateMeralcoBill()"></td>
                                    <td class="text-right">16.38</td>
                                </tr>
                                <tr>
                                    <td class="pl-12 py-1">Supply Charge per kWh</td>
                                    <td class="text-center" id="m-supply-base">--</td>
                                    <td class="text-center"><input type="number" id="m-rate-supply-kwh" value="0.4979"
                                            step="0.0001" class="table-input w-24 text-center"
                                            oninput="calculateMeralcoBill()"></td>
                                    <td class="text-right" id="m-supply-amt">0.00</td>
                                </tr>

                                <!-- Subsidies -->
                                <tr class="section-header-row">
                                    <td class="p-3">Subsidies <span id="m-subs-pct"
                                            class="text-[10px] font-medium ml-2 opacity-60 text-white"></span></td>
                                    <td colspan="2"></td>
                                    <td class="p-3 text-right" id="m-subs-total">0.00</td>
                                </tr>
                                <tr>
                                    <td class="pl-8 py-2">Lifeline Rate Subsidy</td>
                                    <td class="text-center" id="m-life-base">--</td>
                                    <td class="text-center"><input type="number" id="m-rate-life" value="0.0008"
                                            step="0.0001" class="table-input w-24 text-center"
                                            oninput="calculateMeralcoBill()"></td>
                                    <td class="text-right" id="m-life-amt">0.00</td>
                                </tr>
                                <tr>
                                    <td class="pl-8 py-2">Senior Citizen Subsidy</td>
                                    <td class="text-center" id="m-senior-base">--</td>
                                    <td class="text-center"><input type="number" id="m-rate-senior" value="0.0001"
                                            step="0.0001" class="table-input w-24 text-center"
                                            oninput="calculateMeralcoBill()"></td>
                                    <td class="text-right" id="m-senior-amt">0.00</td>
                                </tr>

                                <!-- Government Taxes -->
                                <tr class="section-header-row">
                                    <td class="p-3">Government Taxes <span id="m-tax-pct"
                                            class="text-[10px] font-medium ml-2 opacity-60 text-white"></span></td>
                                    <td colspan="2"></td>
                                    <td class="p-3 text-right" id="m-tax-total">0.00</td>
                                </tr>
                                <tr>
                                    <td class="pl-8 py-2 text-[10px] font-bold uppercase">Value Added Tax</td>
                                    <td class="text-center" id="m-vat-base">--</td>
                                    <td class="text-center" id="m-vat-price">--</td>
                                    <td class="text-right" id="m-vat-amt">0.00</td>
                                </tr>
                                <tr>
                                    <td class="pl-8 py-2">Current RPT (PhP/kWh)</td>
                                    <td class="text-center" id="m-rpt-base">--</td>
                                    <td class="text-center"><input type="number" id="m-rate-rpt" value="0.0028"
                                            step="0.0001" class="table-input w-24 text-center"
                                            oninput="calculateMeralcoBill()"></td>
                                    <td class="text-right" id="m-rpt-amt">0.00</td>
                                </tr>
                                <tr>
                                    <td class="pl-8 py-2">Local Franchise Tax</td>
                                    <td class="text-center" id="m-lft-base">--</td>
                                    <td class="text-center"><input type="number" id="m-rate-lft" value="0.6270"
                                            step="0.0001" class="table-input w-24 text-center"
                                            oninput="calculateMeralcoBill()">%</td>
                                    <td class="text-right" id="m-lft-amt">0.00</td>
                                </tr>
                                <tr>
                                    <td class="pl-8 py-2">Energy Tax</td>
                                    <td class="text-center" id="m-etax-base">--</td>
                                    <td class="text-center text-[10px]">Tiered</td>
                                    <td class="text-right" id="m-etax-amt">0.00</td>
                                </tr>

                                <!-- Universal Charges -->
                                <tr class="section-header-row">
                                    <td class="p-3">Universal Charges <span id="m-uc-pct"
                                            class="text-[10px] font-medium ml-2 opacity-60 text-white"></span></td>
                                    <td colspan="2"></td>
                                    <td class="p-3 text-right" id="m-uc-total">0.00</td>
                                </tr>
                                <tr>
                                    <td class="pl-8 py-2">Missionary Elec (SPUG/REDCI)</td>
                                    <td class="text-center" id="m-ucme-base">--</td>
                                    <td class="text-center">0.1993</td>
                                    <td class="text-right" id="m-ucme-amt">0.00</td>
                                </tr>
                                <tr>
                                    <td class="pl-8 py-2">Environmental Fund</td>
                                    <td class="text-center" id="m-uce-base">--</td>
                                    <td class="text-center">0.0025</td>
                                    <td class="text-right" id="m-uce-amt">0.00</td>
                                </tr>
                                <tr>
                                    <td class="pl-8 py-2">NPC Stranded Debts</td>
                                    <td class="text-center" id="m-ucsd-base">--</td>
                                    <td class="text-center">0.0428</td>
                                    <td class="text-right" id="m-ucsd-amt">0.00</td>
                                </tr>

                                <tr>
                                    <td class="pl-8 py-2">FiT-All (Renewable)</td>
                                    <td class="text-center" id="m-fit-base">--</td>
                                    <td class="text-center"><input type="number" id="m-rate-fit" value="0.2073"
                                            step="0.0001" class="table-input w-24 text-center"
                                            oninput="calculateMeralcoBill()"></td>
                                    <td class="text-right" id="m-fit-amt">0.00</td>
                                </tr>
                                <tr>
                                    <td class="pl-8 py-2">GEA-All (Green Energy)</td>
                                    <td class="text-center" id="m-gea-base">--</td>
                                    <td class="text-center"><input type="number" id="m-rate-gea" value="0.0371"
                                            step="0.0001" class="table-input w-24 text-center"
                                            oninput="calculateMeralcoBill()"></td>
                                    <td class="text-right" id="m-gea-amt">0.00</td>
                                </tr>

                                <!-- Net Metering Export -->
                                <tr class="export-row-standard">
                                    <td class="p-4 font-black uppercase italic">
                                        Net Metering Export Energy
                                        <div
                                            class="text-[8px] font-medium text-slate-400 normal-case tracking-normal mt-1 leading-tight">
                                            *Calculated using the previous month's blended generation rate.
                                        </div>
                                    </td>
                                    <td class="text-center font-bold" id="m-exp-base">--</td>
                                    <td class="text-center font-bold" id="m-exp-price">-7.7471</td>
                                    <td class="text-right font-black text-xl" id="m-exp-amt">- 0.00</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="bg-slate-900 p-8 text-white flex justify-between items-center">
                        <div class="space-y-4">
                            <div class="text-left">
                                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Total
                                    Energy Amount</p>
                                <p class="text-2xl font-black text-white" id="m-gross-total">₱ 0.00</p>
                            </div>
                            <div class="text-left">
                                <p class="text-[10px] font-black text-emerald-400 uppercase tracking-widest mb-1">Export
                                    Credit Applied</p>
                                <p class="text-2xl font-black text-emerald-400" id="m-export-credit">- ₱ 0.00</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-[10px] font-black text-orange-400 uppercase tracking-widest mb-1">Net Amount
                                Payable</p>
                            <p class="text-6xl font-black tracking-tighter text-white" id="m-final-total">₱ 0.00</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 2: ANALYTICS & COMPARISON -->
        <!-- TAB: ANALYTICS & COMPARISON (COOP) -->
        <div id="tab-analytics-coop-content" class="hidden space-y-6">
            <!-- ROI PANEL -->
            <div class="card p-8 border-t-4 border-blue-600">
                <div class="flex flex-col md:flex-row justify-between gap-8">
                    <div class="md:w-1/3 space-y-6">
                        <h3 class="text-xl font-black text-slate-900 uppercase tracking-tight flex items-center gap-2">
                            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                                </path>
                            </svg>
                            ROI Calculator
                        </h3>
                        <div class="space-y-4">
                            <div class="input-group">
                                <label>Investment per kWp (PhP)</label>
                                <input type="number" id="roi-cost-kw" value="30000" oninput="calculateBill()"
                                    class="input-premium">
                            </div>
                            <div class="p-4 bg-slate-50 rounded-xl border border-slate-100">
                                <p class="text-[10px] font-black text-slate-400 uppercase">Total Estimated CAPEX</p>
                                <p class="text-xl font-black text-slate-900" id="roi-total-capex">₱ 0.00</p>
                            </div>
                        </div>
                    </div>

                    <div class="flex-1 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div
                            class="p-6 bg-blue-600 text-white rounded-3xl shadow-xl shadow-blue-100 flex flex-col justify-center">
                            <p class="text-[10px] font-black uppercase opacity-60 mb-2">Monthly Cash Flow Benefit</p>
                            <p class="text-4xl font-black" id="roi-monthly-savings">₱ 0.00</p>
                            <p class="text-[10px] mt-4 opacity-80 font-medium">Monthly Savings vs Traditional Grid
                                Billing.</p>
                        </div>
                        <div
                            class="p-6 bg-emerald-50 border border-emerald-100 rounded-3xl flex flex-col justify-center text-center">
                            <p class="text-[10px] font-black text-emerald-600 uppercase mb-2 tracking-[0.2em]">Simple
                                Payback Period</p>
                            <p class="text-5xl font-black text-emerald-900"><span id="roi-payback-val">0.0</span> <span
                                    class="text-sm font-bold uppercase text-emerald-600">Years</span></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- COMPARISON PANEL -->
            <div class="card p-8 border-t-4 border-slate-900">
                <div class="flex justify-between items-center mb-8">
                    <h3 class="text-xl font-black text-slate-900 uppercase tracking-tight">Scenario Comparison Dashboard
                    </h3>
                    <div class="bg-slate-50 p-2 rounded-xl border border-slate-100 flex items-center gap-3">
                        <label class="text-[10px] font-black text-slate-400 uppercase">Fixed Monthly Fee
                            (Developer):</label>
                        <input type="number" id="ppa-rate" value="5000" step="100" oninput="calculateBill()"
                            class="w-20 px-2 py-1 bg-white border border-blue-200 rounded text-xs font-bold text-blue-900 outline-none">
                        <span class="text-[10px] font-bold text-slate-400">PHP/mo</span>
                    </div>
                </div>

                <div id="ranking-summary" class="mb-8 p-6 bg-slate-900 rounded-3xl text-white relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-8 opacity-10">
                        <svg class="w-24 h-24 text-white" fill="currentColor" viewBox="0 0 24 24">
                            <path
                                d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z">
                            </path>
                        </svg>
                    </div>
                    <div class="flex flex-col md:flex-row md:items-center gap-6 relative z-10">
                        <div class="p-4 bg-emerald-500 rounded-2xl shadow-xl shadow-emerald-500/20 w-fit">
                            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                                    d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                        </div>
                        <div>
                            <h4 class="text-xs font-black uppercase tracking-[0.3em] text-emerald-400 mb-2">Expert Smart
                                Analysis</h4>
                            <p id="best-scenario-text" class="text-lg font-black tracking-tight leading-tight">Analyzing
                                market rates and your consumption profile...</p>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Scenario 1: Traditional -->
                    <div class="p-6 rounded-3xl border border-slate-100 bg-white relative overflow-hidden group">
                        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                            <svg class="w-12 h-12" fill="currentColor" viewBox="0 0 20 20">
                                <path
                                    d="M10 2a8 8 0 100 16 8 8 0 000-16zM5 9a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1z">
                                </path>
                            </svg>
                        </div>
                        <div id="rank-badge-a"
                            class="absolute top-4 left-4 px-3 py-1 bg-slate-100 text-[10px] font-black rounded-full uppercase tracking-widest z-10 border border-slate-200">
                            RANK #--</div>
                        <p class="text-[10px] font-black text-slate-400 uppercase mb-4 tracking-widest">A. Traditional
                            Grid</p>
                        <p class="text-4xl font-black text-slate-900 mb-6" id="comp-trad">₱ 0.00</p>
                        <div class="space-y-3 pt-6 border-t border-slate-50">
                            <div class="flex justify-between text-[11px] font-bold">
                                <span class="text-slate-400 uppercase">Utility Pymt</span>
                                <span class="text-slate-700" id="comp-trad-util">₱ 0.00</span>
                            </div>
                            <div class="flex justify-between text-[11px] font-bold">
                                <span class="text-slate-400 uppercase">Solar Pymt</span>
                                <span class="text-slate-300">N/A</span>
                            </div>
                        </div>
                    </div>

                    <!-- Scenario 2: DER Exporting -->
                    <div
                        class="p-6 rounded-3xl border border-emerald-100 bg-emerald-50/50 relative overflow-hidden shadow-lg shadow-emerald-50 ring-2 ring-emerald-500 ring-offset-2">
                        <div class="absolute top-0 right-0 p-4 opacity-10">
                            <svg class="w-12 h-12 text-emerald-600" fill="currentColor" viewBox="0 0 20 20">
                                <path
                                    d="M11 3a1 1 0 10-2 0v1a1 1 0 102 0V3zM5.884 6.607a1 1 0 011.414 0l.707.707a1 1 0 11-1.414 1.414l-.707-.707a1 1 0 010-1.414zm9.9 0a1 1 0 010 1.414l-.707.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM3 11a1 1 0 100-2H2a1 1 0 100 2h1zm15 0a1 1 0 100-2h-1a1 1 0 100 2h1zM5.05 15.05a1 1 0 011.414 0l.707.707a1 1 0 01-1.414 1.414l-.707-.707a1 1 0 010-1.414zm9.9 0a1 1 0 010 1.414l-.707.707a1 1 0-1.414-1.414l.707-.707a1 1 0 010 1.414zM10 11a1 1 0 100-2 1 1 0 000 2z">
                                </path>
                            </svg>
                        </div>
                        <div id="rank-badge-b"
                            class="absolute top-4 left-4 px-3 py-1 bg-emerald-500 text-white text-[10px] font-black rounded-full uppercase tracking-widest z-10">
                            RANK #--</div>
                        <p class="text-[10px] font-black text-emerald-600 uppercase mb-4 tracking-widest">B.
                            Net-Metering System (Current)</p>
                        <p class="text-4xl font-black text-emerald-900 mb-6" id="comp-der-exp">₱ 0.00</p>
                        <div class="space-y-3 pt-6 border-t border-emerald-100">
                            <div class="flex justify-between text-[11px] font-bold">
                                <span class="text-emerald-600 uppercase opacity-60">Utility Pymt</span>
                                <span class="text-emerald-900" id="comp-der-exp-util">₱ 0.00</span>
                            </div>
                            <div class="flex justify-between text-[11px] font-bold">
                                <span class="text-emerald-600 uppercase opacity-60">Solar Pymt</span>
                                <span class="text-emerald-900">₱ 0.00 (Self-Owned)</span>
                            </div>
                        </div>
                    </div>

                    <!-- Scenario 3: DER Non-Exporting PPA -->
                    <div class="p-6 rounded-3xl border border-blue-100 bg-blue-50/50 relative overflow-hidden">
                        <div class="absolute top-0 right-0 p-4 opacity-10">
                            <svg class="w-12 h-12 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd"
                                    d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6h10v6H6v-6z"
                                    clip-rule="evenodd"></path>
                            </svg>
                        </div>
                        <div id="rank-badge-c"
                            class="absolute top-4 left-4 px-3 py-1 bg-blue-500 text-white text-[10px] font-black rounded-full uppercase tracking-widest z-10">
                            RANK #--</div>
                        <p class="text-[10px] font-black text-blue-600 uppercase mb-4 tracking-widest">C. Non-Exporting
                            (PPA)</p>
                        <p class="text-4xl font-black text-blue-900 mb-6" id="comp-der-ppa">₱ 0.00</p>
                        <div class="space-y-3 pt-6 border-t border-blue-100">
                            <div class="flex justify-between text-[11px] font-bold">
                                <span class="text-blue-600 uppercase opacity-60">Utility Pymt</span>
                                <span class="text-blue-900" id="comp-der-ppa-util">₱ 0.00</span>
                            </div>
                            <div class="flex justify-between text-[11px] font-bold">
                                <span class="text-blue-600 uppercase opacity-60">Developer Pymt</span>
                                <span class="text-blue-900 font-black" id="comp-der-ppa-contract">₱ 0.00</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: ANALYTICS & COMPARISON (MERALCO) -->
        <div id="tab-analytics-meralco-content" class="hidden space-y-6">
            <!-- ROI PANEL -->
            <div class="card p-8 border-t-4 border-orange-600">
                <div class="flex flex-col md:flex-row justify-between gap-8">
                    <div class="md:w-1/3 space-y-6">
                        <h3 class="text-xl font-black text-slate-900 uppercase tracking-tight flex items-center gap-2">
                            <svg class="w-5 h-5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                                </path>
                            </svg>
                            Meralco ROI Calculator
                        </h3>
                        <div class="space-y-4">
                            <div class="input-group">
                                <label>Investment per kWp (PhP)</label>
                                <input type="number" id="m-roi-cost-kw" value="30000" oninput="calculateMeralcoBill()"
                                    class="input-premium">
                            </div>
                            <div class="p-4 bg-slate-50 rounded-xl border border-slate-100">
                                <p class="text-[10px] font-black text-slate-400 uppercase">Total Estimated CAPEX</p>
                                <p class="text-xl font-black text-slate-900" id="m-roi-total-capex">₱ 0.00</p>
                            </div>
                        </div>
                    </div>

                    <div class="flex-1 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div
                            class="p-6 bg-orange-600 text-white rounded-3xl shadow-xl shadow-orange-100 flex flex-col justify-center">
                            <p class="text-[10px] font-black uppercase opacity-60 mb-2">Monthly Cash Flow Benefit</p>
                            <p class="text-4xl font-black" id="m-roi-monthly-savings">₱ 0.00</p>
                            <p class="text-[10px] mt-4 opacity-80 font-medium">Monthly Savings vs Traditional Meralco
                                Billing.</p>
                        </div>
                        <div
                            class="p-6 bg-orange-50 border border-orange-100 rounded-3xl flex flex-col justify-center text-center">
                            <p class="text-[10px] font-black text-orange-600 uppercase mb-2 tracking-[0.2em]">Simple
                                Payback Period</p>
                            <p class="text-5xl font-black text-orange-900"><span id="m-roi-payback-val">0.0</span> <span
                                    class="text-sm font-bold uppercase text-orange-600">Years</span></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- COMPARISON PANEL -->
            <div class="card p-8 border-t-4 border-slate-900">
                <div class="flex justify-between items-center mb-8">
                    <h3 class="text-xl font-black text-slate-900 uppercase tracking-tight">Meralco Scenario Comparison
                        Dashboard
                    </h3>
                    <div class="bg-slate-50 p-2 rounded-xl border border-slate-100 flex items-center gap-3">
                        <label class="text-[10px] font-black text-slate-400 uppercase">Fixed Monthly Fee
                            (Developer):</label>
                        <input type="number" id="m-ppa-rate" value="5000" step="100" oninput="calculateMeralcoBill()"
                            class="w-20 px-2 py-1 bg-white border border-blue-200 rounded text-xs font-bold text-blue-900 outline-none">
                        <span class="text-[10px] font-bold text-slate-400">PHP/mo</span>
                    </div>
                </div>

                <div id="m-ranking-summary"
                    class="mb-8 p-6 bg-slate-900 rounded-3xl text-white relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-8 opacity-10">
                        <svg class="w-24 h-24 text-white" fill="currentColor" viewBox="0 0 24 24">
                            <path
                                d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z">
                            </path>
                        </svg>
                    </div>
                    <div class="flex flex-col md:flex-row md:items-center gap-6 relative z-10">
                        <div class="p-4 bg-orange-500 rounded-2xl shadow-xl shadow-orange-500/20 w-fit">
                            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                                    d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                        </div>
                        <div>
                            <h4 class="text-xs font-black uppercase tracking-[0.3em] text-orange-400 mb-2">Meralco
                                Expert Analysis</h4>
                            <p id="m-best-scenario-text" class="text-lg font-black tracking-tight leading-tight">
                                Analyzing
                                meralco rates and your solar profile...</p>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Scenario 1: Traditional -->
                    <div class="p-6 rounded-3xl border border-slate-100 bg-white relative overflow-hidden group">
                        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                            <svg class="w-12 h-12" fill="currentColor" viewBox="0 0 20 20">
                                <path
                                    d="M10 2a8 8 0 100 16 8 8 0 000-16zM5 9a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1z">
                                </path>
                            </svg>
                        </div>
                        <div id="m-rank-badge-a"
                            class="absolute top-4 left-4 px-3 py-1 bg-slate-100 text-[10px] font-black rounded-full uppercase tracking-widest z-10 border border-slate-200">
                            RANK #--</div>
                        <p class="text-[10px] font-black text-slate-400 uppercase mb-4 tracking-widest">A. Traditional
                            Meralco</p>
                        <p class="text-4xl font-black text-slate-900 mb-6" id="m-comp-trad">₱ 0.00</p>
                        <div class="space-y-3 pt-6 border-t border-slate-50">
                            <div class="flex justify-between text-[11px] font-bold">
                                <span class="text-slate-400 uppercase">Utility Pymt</span>
                                <span class="text-slate-700" id="m-comp-trad-util">₱ 0.00</span>
                            </div>
                            <div class="flex justify-between text-[11px] font-bold">
                                <span class="text-slate-400 uppercase">Solar Pymt</span>
                                <span class="text-slate-300">N/A</span>
                            </div>
                        </div>
                    </div>

                    <!-- Scenario 2: DER Exporting -->
                    <div
                        class="p-6 rounded-3xl border border-orange-100 bg-orange-50/50 relative overflow-hidden shadow-lg shadow-orange-50 ring-2 ring-orange-500 ring-offset-2">
                        <div class="absolute top-0 right-0 p-4 opacity-10">
                            <svg class="w-12 h-12 text-orange-600" fill="currentColor" viewBox="0 0 20 20">
                                <path
                                    d="M11 3a1 1 0 10-2 0v1a1 1 0 102 0V3zM5.884 6.607a1 1 0 011.414 0l.707.707a1 1 0 11-1.414 1.414l-.707-.707a1 1 0 010-1.414zm9.9 0a1 1 0 010 1.414l-.707.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM3 11a1 1 0 100-2H2a1 1 0 100 2h1zm15 0a1 1 0 100-2h-1a1 1 0 100 2h1zM5.05 15.05a1 1 0 011.414 0l.707.707a1 1 0 01-1.414 1.414l-.707-.707a1 1 0 010-1.414zm9.9 0a1 1 0 010 1.414l-.707.707a1 1 0-1.414-1.414l.707-.707a1 1 0 010 1.414zM10 11a1 1 0 100-2 1 1 0 000 2z">
                                </path>
                            </svg>
                        </div>
                        <div id="m-rank-badge-b"
                            class="absolute top-4 left-4 px-3 py-1 bg-orange-500 text-white text-[10px] font-black rounded-full uppercase tracking-widest z-10">
                            RANK #--</div>
                        <p class="text-[10px] font-black text-orange-600 uppercase mb-4 tracking-widest">B.
                            Net-Metering Meralco</p>
                        <p class="text-4xl font-black text-orange-900 mb-6" id="m-comp-der-exp">₱ 0.00</p>
                        <div class="space-y-3 pt-6 border-t border-orange-100">
                            <div class="flex justify-between text-[11px] font-bold">
                                <span class="text-orange-600 uppercase opacity-60">Utility Pymt</span>
                                <span class="text-orange-900" id="m-comp-der-exp-util">₱ 0.00</span>
                            </div>
                            <div class="flex justify-between text-[11px] font-bold">
                                <span class="text-orange-600 uppercase opacity-60">Solar Pymt</span>
                                <span class="text-orange-900">₱ 0.00 (Self-Owned)</span>
                            </div>
                        </div>
                    </div>

                    <!-- Scenario 3: DER Non-Exporting PPA -->
                    <div class="p-6 rounded-3xl border border-blue-100 bg-blue-50/50 relative overflow-hidden">
                        <div class="absolute top-0 right-0 p-4 opacity-10">
                            <svg class="w-12 h-12 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd"
                                    d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6h10v6H6v-6z"
                                    clip-rule="evenodd"></path>
                            </svg>
                        </div>
                        <div id="m-rank-badge-c"
                            class="absolute top-4 left-4 px-3 py-1 bg-blue-500 text-white text-[10px] font-black rounded-full uppercase tracking-widest z-10">
                            RANK #--</div>
                        <p class="text-[10px] font-black text-blue-600 uppercase mb-4 tracking-widest">C. Non-Exporting
                            (PPA)</p>
                        <p class="text-4xl font-black text-blue-900 mb-6" id="m-comp-der-ppa">₱ 0.00</p>
                        <div class="space-y-3 pt-6 border-t border-blue-100">
                            <div class="flex justify-between text-[11px] font-bold">
                                <span class="text-blue-600 uppercase opacity-60">Utility Pymt</span>
                                <span class="text-blue-900" id="m-comp-der-ppa-util">₱ 0.00</span>
                            </div>
                            <div class="flex justify-between text-[11px] font-bold">
                                <span class="text-blue-600 uppercase opacity-60">Developer Pymt</span>
                                <span class="text-blue-900 font-black" id="m-comp-der-ppa-contract">₱ 0.00</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


    </div>

    <script>
        const formatNumber = (num) => num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        const setUI = (id, text) => { const el = document.getElementById(id); if (el) el.innerText = text; };

        // Random offsets for "Previous Month Blended Generation Rate" logic
        const exportPriceOffset = (Math.random() * 0.32) - 0.16;
        const mExportPriceOffset = (Math.random() * 0.32) - 0.16;

        function switchTab(view) {
            const bill = document.getElementById('tab-bill-content');
            const meralco = document.getElementById('tab-meralco-content');
            const analyticsCoop = document.getElementById('tab-analytics-coop-content');
            const analyticsMeralco = document.getElementById('tab-analytics-meralco-content');

            const buttons = {
                'bill': document.getElementById('btn-bill'),
                'meralco': document.getElementById('btn-meralco'),
                'analytics-coop': document.getElementById('btn-analytics-coop'),
                'analytics-meralco': document.getElementById('btn-analytics-meralco')
            };

            if (bill) bill.classList.toggle('hidden', view !== 'bill');
            if (meralco) meralco.classList.toggle('hidden', view !== 'meralco');
            if (analyticsCoop) analyticsCoop.classList.toggle('hidden', view !== 'analytics-coop');
            if (analyticsMeralco) analyticsMeralco.classList.toggle('hidden', view !== 'analytics-meralco');

            Object.keys(buttons).forEach(key => {
                if (buttons[key]) {
                    buttons[key].className = (key === view) ? "tab-btn active" : "tab-btn text-slate-500";
                }
            });

            // Re-calculate when switching to ensure UI is fresh
            calculateBill();
            calculateMeralcoBill();
        }

        function validateAndCalculate() {
            const el = document.getElementById('derCapacityKWp');
            const warn = document.getElementById('cap-warning');

            if (parseFloat(el.value) > 100) {
                el.value = 100;
                el.classList.add('border-red-500', 'text-red-600');
                if (warn) warn.classList.remove('hidden');
            } else {
                el.classList.remove('border-red-500', 'text-red-600');
                if (warn) warn.classList.add('hidden');
            }
            calculateBill();
            calculateMeralcoBill();
        }

        function calculateBill() {
            // Helper to get rate from input
            const getR = (id) => {
                const el = document.getElementById(id);
                return el ? parseFloat(el.value) || 0 : 0;
            };

            // Updated Rates (Fetched from UI inputs)
            const rates = {
                gen: getR('rate-gen'),
                host: getR('rate-host'),
                poweract: getR('rate-poweract'),
                transDemand: getR('rate-trans-demand'),
                trans: getR('rate-trans'),
                sl: getR('rate-sl'),
                distEnergy: getR('rate-dist-energy'),
                distDemand: getR('rate-dist-demand'),
                supply: getR('rate-supply'),
                supplyFix: getR('rate-supply-fix'),
                metering: getR('rate-metering'),
                meteringFix: getR('rate-metering-fix'),
                reinvest: getR('rate-reinvest'),
                life: getR('rate-life'),
                senior: getR('rate-senior'),
                lftEnergy: getR('rate-lft-energy'),
                lftDemand: getR('rate-lft-demand'),
                lftFix: getR('rate-lft-fix'),
                busTax: getR('rate-bus-tax'),
                rpt: getR('rate-rpt'),
                genVat: getR('rate-gen-vat'),
                transVat: getR('rate-trans-vat'),
                slVat: getR('rate-sl-vat'),
                distVatKwh: getR('rate-dist-vat-kwh'),
                distVatFix: getR('rate-dist-vat-fix'),
                subsVat: getR('rate-subs-vat'),
                ucSd: getR('rate-uc-sd'),
                ucSpug: getR('rate-uc-spug'),
                ucRedci: getR('rate-uc-redci'),
                ucEnv: getR('rate-uc-env'),
                fit: getR('rate-fit'),
                gea: getR('rate-gea')
            };

            // Update display for fixed charges
            setUI('disp-supply-fix', formatNumber(rates.supplyFix));
            setUI('disp-metering-fix', formatNumber(rates.meteringFix));

            const derKWp = parseFloat(document.getElementById('derCapacityKWp').value) || 0;
            const cf = parseFloat(document.getElementById('capacityFactor').value) || 0;
            const importKwh = parseFloat(document.getElementById('importKwh').value) || 0;
            const exportKwh = parseFloat(document.getElementById('exportKwh').value) || 0;
            const demandKw = parseFloat(document.getElementById('demandKw').value) || 0;
            const ppaRate = parseFloat(document.getElementById('ppa-rate').value) || 0;

            const solarGen = derKWp * 24 * 30 * (cf / 100);
            const actualConsumption = importKwh - exportKwh + solarGen;

            // 1. Generation & Transmission
            const genAmt = importKwh * rates.gen;
            const hostAmt = importKwh * rates.host;
            const powerAmt = importKwh * rates.poweract;
            const transDemandAmt = demandKw * rates.transDemand;
            const transSystemAmt = importKwh * rates.trans;
            const slAmt = importKwh * rates.sl;
            const genTransSubtotal = genAmt + hostAmt + powerAmt + transDemandAmt + transSystemAmt + slAmt;

            // 2. Distribution
            const distEnergyAmt = importKwh * rates.distEnergy;
            const distDemandAmt = demandKw * rates.distDemand;
            const supplySystemAmt = importKwh * rates.supply;
            const supplyFixAmt = rates.supplyFix;
            const meteringSystemAmt = importKwh * rates.metering;
            const meteringFixAmt = rates.meteringFix;
            const reinvestAmt = importKwh * rates.reinvest;
            const distSubtotal = distEnergyAmt + distDemandAmt + supplySystemAmt + supplyFixAmt + meteringSystemAmt + meteringFixAmt + reinvestAmt;

            // 3. Subsidy & Discount
            const lifeAmt = actualConsumption * rates.life;
            const seniorAmt = actualConsumption * rates.senior;
            const subsSubtotal = lifeAmt + seniorAmt;

            // 4. Local Taxes
            const lftEnergyAmt = importKwh * rates.lftEnergy;
            const lftDemandAmt = demandKw * rates.lftDemand;
            const lftFixAmt = rates.lftFix;
            const busTaxAmt = importKwh * rates.busTax;
            const rptAmt = importKwh * rates.rpt;
            const taxSubtotal = lftEnergyAmt + lftDemandAmt + lftFixAmt + busTaxAmt + rptAmt;

            // 5. Value Added Tax
            const genVatAmt = importKwh * rates.genVat;
            const transVatAmt = importKwh * rates.transVat;
            const slVatAmt = importKwh * rates.slVat;
            const distVatEnergyAmt = importKwh * rates.distVatKwh;
            const distVatFixAmt = rates.distVatFix;
            const distVatAmt = distVatEnergyAmt + distVatFixAmt;
            const subsVatAmt = actualConsumption * rates.subsVat;
            const vatSubtotal = genVatAmt + transVatAmt + slVatAmt + distVatAmt + subsVatAmt;

            // 6. Universal Charges
            const ucSdAmt = importKwh * rates.ucSd;
            const ucSpugAmt = importKwh * rates.ucSpug;
            const ucRedciAmt = importKwh * rates.ucRedci;
            const ucEnvAmt = importKwh * rates.ucEnv;
            const fitAmt = actualConsumption * rates.fit;
            const geaAmt = actualConsumption * rates.gea;
            const ucSubtotal = ucSdAmt + ucSpugAmt + ucRedciAmt + ucEnvAmt + fitAmt + geaAmt;

            const grossTotal = genTransSubtotal + distSubtotal + subsSubtotal + taxSubtotal + vatSubtotal + ucSubtotal;

            // Net-Metering Credit uses previous month's blended generation rate (with random offset)
            const exportPrice = (rates.gen + rates.host) + exportPriceOffset;
            const derCredit = exportKwh * exportPrice;
            const netAmount = grossTotal - derCredit;

            // Scenario 1: Traditional (No Solar)
            const tradVolume = solarGen - exportKwh + importKwh;
            const tradGenTrans = tradVolume * (rates.gen + rates.host + rates.poweract + rates.trans + rates.sl) + (demandKw * rates.transDemand);
            const tradDist = (tradVolume * (rates.distEnergy + rates.supply + rates.metering + rates.reinvest)) + (demandKw * rates.distDemand) + rates.supplyFix + rates.meteringFix;
            const tradSubs = actualConsumption * (rates.life + rates.senior);
            const tradTax = (tradVolume * (rates.lftEnergy + rates.busTax + rates.rpt)) + (demandKw * rates.lftDemand) + rates.lftFix;
            const tradVat = (tradVolume * (rates.genVat + rates.transVat + rates.slVat + rates.distVatKwh)) + rates.distVatFix + (actualConsumption * rates.subsVat);
            const tradUc = (tradVolume * (rates.ucSd + rates.ucSpug + rates.ucRedci + rates.ucEnv)) + (actualConsumption * (rates.fit + rates.gea));
            const traditionalTotal = tradGenTrans + tradDist + tradSubs + tradTax + tradVat + tradUc;

            // UI Updates
            setUI('math-import', importKwh.toLocaleString());
            setUI('math-export', exportKwh.toLocaleString());
            setUI('math-gen', Math.round(solarGen).toLocaleString());
            setUI('math-actual', Math.round(actualConsumption).toLocaleString() + " kWh (Gross)");

            let payableAmount = netAmount;
            let rolloverCredit = 0;
            if (netAmount < 0) {
                payableAmount = 0;
                rolloverCredit = Math.abs(netAmount);
            }

            setUI('sideTotal', "₱ " + formatNumber(payableAmount));
            if (rolloverCredit > 0) {
                const rollBox = document.getElementById('rollover-box');
                if (rollBox) rollBox.classList.remove('hidden');
                setUI('sideRollover', "₱ " + formatNumber(rolloverCredit));
            } else {
                const rollBox = document.getElementById('rollover-box');
                if (rollBox) rollBox.classList.add('hidden');
            }
            setUI('tierDisp', "NM");

            // Detailed Table Updates
            setUI('det-gen-trans-total', formatNumber(genTransSubtotal));
            setUI('li-gen-base', importKwh.toLocaleString() + " kWh"); setUI('li-gen-amt', formatNumber(genAmt));
            setUI('li-host-base', importKwh.toLocaleString() + " kWh"); setUI('li-host-amt', formatNumber(hostAmt));
            setUI('li-power-base', importKwh.toLocaleString() + " kWh"); setUI('li-power-amt', formatNumber(powerAmt));
            setUI('li-trans-demand-base', demandKw.toLocaleString() + " kW"); setUI('li-trans-demand-amt', formatNumber(transDemandAmt));
            setUI('li-trans-base', importKwh.toLocaleString() + " kWh"); setUI('li-trans-amt', formatNumber(transSystemAmt));
            setUI('li-sl-base', importKwh.toLocaleString() + " kWh"); setUI('li-sl-amt', formatNumber(slAmt));

            setUI('det-dist-total', formatNumber(distSubtotal));
            setUI('li-dist-energy-base', importKwh.toLocaleString() + " kWh"); setUI('li-dist-energy-amt', formatNumber(distEnergyAmt));
            setUI('li-dist-demand-base', demandKw.toLocaleString() + " kW"); setUI('li-dist-demand-amt', formatNumber(distDemandAmt));
            setUI('li-supply-base', importKwh.toLocaleString() + " kWh"); setUI('li-supply-amt', formatNumber(supplySystemAmt));
            setUI('li-metering-base', importKwh.toLocaleString() + " kWh"); setUI('li-metering-amt', formatNumber(meteringSystemAmt));
            setUI('li-reinvest-base', importKwh.toLocaleString() + " kWh"); setUI('li-reinvest-amt', formatNumber(reinvestAmt));

            setUI('det-subs-total', formatNumber(subsSubtotal));
            setUI('li-life-base', Math.round(actualConsumption).toLocaleString() + " kWh"); setUI('li-life-amt', formatNumber(lifeAmt));
            setUI('li-senior-base', Math.round(actualConsumption).toLocaleString() + " kWh"); setUI('li-senior-amt', formatNumber(seniorAmt));

            setUI('det-tax-total', formatNumber(taxSubtotal));
            setUI('li-lft-energy-base', importKwh.toLocaleString() + " kWh"); setUI('li-lft-energy-amt', formatNumber(lftEnergyAmt));
            setUI('li-lft-demand-base', demandKw.toLocaleString() + " kW"); setUI('li-lft-demand-amt', formatNumber(lftDemandAmt));
            setUI('li-lft-fix-amt', formatNumber(lftFixAmt));
            setUI('li-bus-tax-base', importKwh.toLocaleString() + " kWh"); setUI('li-bus-tax-amt', formatNumber(busTaxAmt));
            setUI('li-rpt-base', importKwh.toLocaleString() + " kWh"); setUI('li-rpt-amt', formatNumber(rptAmt));

            setUI('det-vat-total', formatNumber(vatSubtotal));
            setUI('li-gen-vat-base', importKwh.toLocaleString() + " kWh"); setUI('li-gen-vat-amt', formatNumber(genVatAmt));
            setUI('li-trans-vat-base', importKwh.toLocaleString() + " kWh"); setUI('li-trans-vat-amt', formatNumber(transVatAmt));
            setUI('li-sl-vat-base', importKwh.toLocaleString() + " kWh"); setUI('li-sl-vat-amt', formatNumber(slVatAmt));
            setUI('li-dist-vat-kwh-base', importKwh.toLocaleString() + " kWh"); setUI('li-dist-vat-kwh-amt', formatNumber(distVatEnergyAmt));
            setUI('li-dist-vat-fix-amt', formatNumber(distVatFixAmt));
            setUI('li-subs-vat-base', Math.round(actualConsumption).toLocaleString() + " kWh"); setUI('li-subs-vat-amt', formatNumber(subsVatAmt));

            setUI('det-uc-total', formatNumber(ucSubtotal));
            setUI('li-uc-sd-base', importKwh.toLocaleString() + " kWh"); setUI('li-uc-sd-amt', formatNumber(ucSdAmt));
            setUI('li-uc-spug-base', importKwh.toLocaleString() + " kWh"); setUI('li-uc-spug-amt', formatNumber(ucSpugAmt));
            setUI('li-uc-redci-base', importKwh.toLocaleString() + " kWh"); setUI('li-uc-redci-amt', formatNumber(ucRedciAmt));
            setUI('li-uc-env-base', importKwh.toLocaleString() + " kWh"); setUI('li-uc-env-amt', formatNumber(ucEnvAmt));
            setUI('li-fit-base', Math.round(actualConsumption).toLocaleString() + " kWh"); setUI('li-fit-amt', formatNumber(fitAmt));
            setUI('li-gea-base', Math.round(actualConsumption).toLocaleString() + " kWh"); setUI('li-gea-amt', formatNumber(geaAmt));

            setUI('li-export-base', exportKwh.toLocaleString() + " kWh"); setUI('li-export-price', exportPrice.toFixed(4)); setUI('det-der-credit', "- " + formatNumber(derCredit));
            setUI('footer-total', "₱ " + formatNumber(payableAmount));

            // Analytics Panel UI
            setUI('roi-total-capex', "₱ " + formatNumber(derKWp * getR('roi-cost-kw')));
            setUI('roi-monthly-savings', "₱ " + formatNumber(traditionalTotal - payableAmount));
            setUI('roi-payback-val', (traditionalTotal - payableAmount > 0) ? ((derKWp * getR('roi-cost-kw')) / ((traditionalTotal - payableAmount) * 12)).toFixed(1) : "0.0");
            setUI('comp-trad', "₱ " + formatNumber(traditionalTotal)); setUI('comp-trad-util', "₱ " + formatNumber(traditionalTotal));
            setUI('comp-der-exp', "₱ " + formatNumber(payableAmount)); setUI('comp-der-exp-util', "₱ " + formatNumber(payableAmount));

            // Scenario 3: PPA (Non-Exporting)
            const solarPaymentPPA = getR('ppa-rate');
            const gridImportBill = grossTotal; // No credit in non-export
            const ppaTotal = gridImportBill + solarPaymentPPA;

            setUI('comp-der-ppa', "₱ " + formatNumber(ppaTotal));
            setUI('comp-der-ppa-util', "₱ " + formatNumber(gridImportBill));
            setUI('comp-der-ppa-contract', "₱ " + formatNumber(solarPaymentPPA));

            // Smart Ranking Engine
            const scenarios = [
                { id: 'A', name: 'Traditional Grid', cost: traditionalTotal, badge: 'rank-badge-a' },
                { id: 'B', name: 'Net-Metering System', cost: payableAmount, badge: 'rank-badge-b' },
                { id: 'C', name: 'Non-Exporting (PPA)', cost: ppaTotal, badge: 'rank-badge-c' }
            ];

            scenarios.sort((a, b) => a.cost - b.cost);

            scenarios.forEach((s, index) => {
                const rank = index + 1;
                const badgeEl = document.getElementById(s.badge);
                if (badgeEl) {
                    badgeEl.innerText = `RANK #${rank}`;
                    if (rank === 1) {
                        badgeEl.classList.add('ring-4', 'ring-emerald-500/20');
                    } else {
                        badgeEl.classList.remove('ring-4', 'ring-emerald-500/20');
                    }
                }
            });

            const best = scenarios[0];
            const secondaryBest = scenarios[1];
            const monthlySavingsVsTrad = traditionalTotal - best.cost;

            let resultMsg = "";
            if (best.id === 'A') {
                resultMsg = "Surprisingly, the Traditional Grid is currently the most cost-effective option based on your current rates.";
            } else {
                resultMsg = `The <span class="text-emerald-400">${best.name}</span> is your best financial choice, saving you <span class="text-emerald-400">₱${formatNumber(monthlySavingsVsTrad)}/mo</span> compared to the grid.`;
            }
            const bestMsgEl = document.getElementById('best-scenario-text');
            if (bestMsgEl) bestMsgEl.innerHTML = resultMsg;
        }

        function calculateMeralcoBill() {
            const mDerCapacity = parseFloat(document.getElementById('m-derCapacity').value) || 0;
            const mCf = parseFloat(document.getElementById('m-cf').value) || 0;
            const mImport = parseFloat(document.getElementById('m-import').value) || 0;
            const mExport = parseFloat(document.getElementById('m-export').value) || 0;

            const mSolarGen = mDerCapacity * 24 * 30 * (mCf / 100);
            const mActualConsumption = mImport - mExport + mSolarGen;

            // 1. Generation
            const genPrice = parseFloat(document.getElementById('m-rate-gen').value) || 0;
            const genAmt = mImport * genPrice;

            // 2. Transmission
            const transPrice = parseFloat(document.getElementById('m-rate-trans').value) || 0;
            const transAmt = mImport * transPrice;

            // 3. System Loss
            const slPrice = parseFloat(document.getElementById('m-rate-sl').value) || 0;
            const slAmt = mImport * slPrice;

            // 4. Distribution (Residential Tiered)
            let distPrice = 0;
            if (mImport <= 200) distPrice = 0.9803;
            else if (mImport <= 300) distPrice = 1.2908;
            else if (mImport <= 400) distPrice = 1.5837;
            else distPrice = 2.0941;

            const distAmt = mImport * distPrice;
            const meterAmt = (mImport * (parseFloat(document.getElementById('m-rate-metering-kwh').value) || 0)) + (parseFloat(document.getElementById('m-rate-metering-fix').value) || 0);
            const supplyAmt = (mImport * (parseFloat(document.getElementById('m-rate-supply-kwh').value) || 0)) + (parseFloat(document.getElementById('m-rate-supply-fix').value) || 0);
            const distTotal = distAmt + meterAmt + supplyAmt;

            // 5. Subsidies
            const lifePrice = parseFloat(document.getElementById('m-rate-life').value) || 0;
            const seniorPrice = parseFloat(document.getElementById('m-rate-senior').value) || 0;
            const lifeAmt = mActualConsumption * lifePrice;
            const seniorAmt = mActualConsumption * seniorPrice;
            const subsTotal = lifeAmt + seniorAmt;

            // 6. Government Taxes
            // VAT Calculation
            const genVat = genAmt * 0.1131;
            const transVat = transAmt * 0.1028;
            const slVat = slAmt * 0.1110;
            const othersVat = (distTotal + subsTotal) * 0.12;
            const vatTotal = genVat + transVat + slVat + othersVat;

            const rptPrice = parseFloat(document.getElementById('m-rate-rpt').value) || 0;
            const rptAmt = mImport * rptPrice;
            const lftRateVal = (parseFloat(document.getElementById('m-rate-lft').value) || 0) / 100;
            const lftAmt = (genAmt + transAmt + slAmt + distTotal + subsTotal) * lftRateVal;

            // Energy Tax (Residential)
            let etaxAmt = 0;
            if (mImport > 650) {
                const next350 = Math.min(mImport - 650, 350);
                etaxAmt += next350 * 0.10;
                if (mImport > 1000) {
                    const next500 = Math.min(mImport - 1000, 500);
                    etaxAmt += next500 * 0.20;
                    if (mImport > 1500) {
                        const excess = mImport - 1500;
                        etaxAmt += excess * 0.35;
                    }
                }
            }
            const taxTotal = vatTotal + rptAmt + lftAmt + etaxAmt;

            // 7. Universal Charges
            const ucmeAmt = mImport * (0.1949 + 0.0044);
            const uceAmt = mImport * 0.0025;
            const ucsdAmt = mImport * 0.0428;
            const ucTotal = ucmeAmt + uceAmt + ucsdAmt;

            // 8. FiT-All & GEA-All
            const fitPrice = parseFloat(document.getElementById('m-rate-fit').value) || 0;
            const geaPrice = parseFloat(document.getElementById('m-rate-gea').value) || 0;
            const fitAmt = mActualConsumption * fitPrice;
            const geaAmt = mActualConsumption * geaPrice;

            const mGrossTotal = genAmt + transAmt + slAmt + distTotal + subsTotal + taxTotal + ucTotal + fitAmt + geaAmt;

            // Net-Metering Credit uses previous month's blended generation rate (with random offset)
            const mExportPrice = genPrice + mExportPriceOffset;
            const mExportCredit = mExport * mExportPrice;
            const mFinalTotal = Math.max(0, mGrossTotal - mExportCredit);

            // Update UI
            setUI('m-gen-total', formatNumber(genAmt));
            setUI('m-gen-base', mImport.toLocaleString() + " kWh");
            setUI('m-gen-amt', formatNumber(genAmt));

            setUI('m-trans-total', formatNumber(transAmt));
            setUI('m-trans-base', mImport.toLocaleString() + " kWh");
            setUI('m-trans-amt', formatNumber(transAmt));

            setUI('m-sl-total', formatNumber(slAmt));
            setUI('m-sl-base', mImport.toLocaleString() + " kWh");
            setUI('m-sl-amt', formatNumber(slAmt));

            setUI('m-dist-total', formatNumber(distTotal));
            setUI('m-dist-base', mImport.toLocaleString() + " kWh");
            setUI('m-dist-price', distPrice.toFixed(4));
            setUI('m-dist-amt', formatNumber(distAmt));
            setUI('m-meter-base', mImport.toLocaleString() + " kWh");
            setUI('m-meter-amt', formatNumber(mImport * 0.3350));
            setUI('m-supply-base', mImport.toLocaleString() + " kWh");
            setUI('m-supply-amt', formatNumber(mImport * 0.4979));

            setUI('m-subs-total', formatNumber(subsTotal));
            setUI('m-life-base', Math.round(mActualConsumption).toLocaleString() + " kWh");
            setUI('m-life-amt', formatNumber(lifeAmt));
            setUI('m-senior-base', Math.round(mActualConsumption).toLocaleString() + " kWh");
            setUI('m-senior-amt', formatNumber(seniorAmt));

            setUI('m-tax-total', formatNumber(taxTotal));
            setUI('m-vat-base', mImport.toLocaleString() + " kWh");
            setUI('m-vat-amt', formatNumber(vatTotal));
            setUI('m-rpt-base', mImport.toLocaleString() + " kWh");
            setUI('m-rpt-amt', formatNumber(rptAmt));
            setUI('m-lft-base', mImport.toLocaleString() + " kWh");
            setUI('m-lft-amt', formatNumber(lftAmt));
            setUI('m-etax-base', mImport.toLocaleString() + " kWh");
            setUI('m-etax-amt', formatNumber(etaxAmt));

            setUI('m-uc-total', formatNumber(ucTotal));
            setUI('m-ucme-base', mImport.toLocaleString() + " kWh");
            setUI('m-ucme-amt', formatNumber(ucmeAmt));
            setUI('m-uce-base', mImport.toLocaleString() + " kWh");
            setUI('m-uce-amt', formatNumber(uceAmt));
            setUI('m-ucsd-base', mImport.toLocaleString() + " kWh");
            setUI('m-ucsd-amt', formatNumber(ucsdAmt));

            setUI('m-fit-total', formatNumber(fitAmt + geaAmt));
            setUI('m-fit-base', Math.round(mActualConsumption).toLocaleString() + " kWh");
            setUI('m-fit-amt', formatNumber(fitAmt));
            setUI('m-gea-base', Math.round(mActualConsumption).toLocaleString() + " kWh");
            setUI('m-gea-amt', formatNumber(geaAmt));

            setUI('m-exp-base', mExport.toLocaleString() + " kWh");
            setUI('m-exp-price', "- " + mExportPrice.toFixed(4));
            setUI('m-exp-amt', "- " + formatNumber(mExportCredit));

            setUI('m-total-due', "₱ " + formatNumber(mFinalTotal));
            setUI('m-gross-total', "₱ " + formatNumber(mGrossTotal));
            setUI('m-export-credit', "- ₱ " + formatNumber(mExportCredit));
            setUI('m-final-total', "₱ " + formatNumber(mFinalTotal));

            // Meralco Analytics & ROI Calculation
            const mRoiCost = parseFloat(document.getElementById('m-roi-cost-kw').value) || 0;
            const mCapexTotal = mDerCapacity * mRoiCost;
            setUI('m-roi-total-capex', "₱ " + formatNumber(mCapexTotal));

            // Traditional Meralco Calculation (Simplified for ROI)
            const tradImport = mActualConsumption;
            const tradGen = tradImport * genPrice;
            const tradTrans = tradImport * transPrice;
            const tradSL = tradImport * slPrice;

            let tradDistPrice = 0;
            if (tradImport <= 200) tradDistPrice = 0.9803;
            else if (tradImport <= 300) tradDistPrice = 1.2908;
            else if (tradImport <= 400) tradDistPrice = 1.5837;
            else tradDistPrice = 2.0941;

            const tradDistAmt = (tradImport * tradDistPrice) +
                (tradImport * (parseFloat(document.getElementById('m-rate-metering-kwh').value) || 0)) + (parseFloat(document.getElementById('m-rate-metering-fix').value) || 0) +
                (tradImport * (parseFloat(document.getElementById('m-rate-supply-kwh').value) || 0)) + (parseFloat(document.getElementById('m-rate-supply-fix').value) || 0);

            const tradSubs = tradImport * (lifePrice + seniorPrice);

            // Taxes
            const tradVAT = (tradGen * 0.1131) + (tradTrans * 0.1028) + (tradSL * 0.1110) + (tradDistAmt + tradSubs) * 0.12;
            const tradRPT = tradImport * rptPrice;
            const tradLFT = (tradGen + tradTrans + tradSL + tradDistAmt + tradSubs) * lftRateVal;

            let tradETax = 0;
            if (tradImport > 650) {
                const next350 = Math.min(tradImport - 650, 350);
                tradETax += next350 * 0.10;
                if (tradImport > 1000) {
                    const next500 = Math.min(tradImport - 1000, 500);
                    tradETax += next500 * 0.20;
                    if (tradImport > 1500) tradETax += (tradImport - 1500) * 0.35;
                }
            }

            const tradUC = tradImport * (0.1993 + 0.0025 + 0.0428);
            const tradFitGea = tradImport * (fitPrice + geaPrice);

            const mTraditionalTotal = tradGen + tradTrans + tradSL + tradDistAmt + tradSubs + tradVAT + tradRPT + tradLFT + tradETax + tradUC + tradFitGea;

            const mMonthlySavings = mTraditionalTotal - mFinalTotal;
            setUI('m-roi-monthly-savings', "₱ " + formatNumber(mMonthlySavings));
            setUI('m-roi-payback-val', (mMonthlySavings > 0) ? (mCapexTotal / (mMonthlySavings * 12)).toFixed(1) : "0.0");

            // Scenario Comparison
            const mPpaRate = parseFloat(document.getElementById('m-ppa-rate').value) || 0;
            const mPpaTotal = mGrossTotal + mPpaRate;

            setUI('m-comp-trad', "₱ " + formatNumber(mTraditionalTotal));
            setUI('m-comp-trad-util', "₱ " + formatNumber(mTraditionalTotal));
            setUI('m-comp-der-exp', "₱ " + formatNumber(mFinalTotal));
            setUI('m-comp-der-exp-util', "₱ " + formatNumber(mFinalTotal));
            setUI('m-comp-der-ppa', "₱ " + formatNumber(mPpaTotal));
            setUI('m-comp-der-ppa-util', "₱ " + formatNumber(mGrossTotal));
            setUI('m-comp-der-ppa-contract', "₱ " + formatNumber(mPpaRate));

            // Meralco Ranking
            const mScenarios = [
                { id: 'A', name: 'Traditional Meralco', cost: mTraditionalTotal, badge: 'm-rank-badge-a' },
                { id: 'B', name: 'Net-Metering Meralco', cost: mFinalTotal, badge: 'm-rank-badge-b' },
                { id: 'C', name: 'Non-Exporting (PPA)', cost: mPpaTotal, badge: 'm-rank-badge-c' }
            ];

            mScenarios.sort((a, b) => a.cost - b.cost);
            mScenarios.forEach((s, index) => {
                const rank = index + 1;
                const badgeEl = document.getElementById(s.badge);
                if (badgeEl) {
                    badgeEl.innerText = `RANK #${rank}`;
                    if (rank === 1) badgeEl.classList.add('ring-4', 'ring-orange-500/20');
                    else badgeEl.classList.remove('ring-4', 'ring-orange-500/20');
                }
            });

            const mBest = mScenarios[0];
            const mSavingsVsTrad = mTraditionalTotal - mBest.cost;
            let mResultMsg = (mBest.id === 'A') ?
                "The Traditional Meralco rate is currently your best option." :
                `The <span class="text-orange-400">${mBest.name}</span> is your best financial choice, saving you <span class="text-orange-400">₱${formatNumber(mSavingsVsTrad)}/mo</span>.`;

            const mBestMsgEl = document.getElementById('m-best-scenario-text');
            if (mBestMsgEl) mBestMsgEl.innerHTML = mResultMsg;

            // Percentages for Headers
            const total = mGrossTotal;
            if (total > 0) {
                setUI('m-gen-pct', ((genAmt / total) * 100).toFixed(2) + "%");
                setUI('m-trans-pct', ((transAmt / total) * 100).toFixed(2) + "%");
                setUI('m-sl-pct', ((slAmt / total) * 100).toFixed(2) + "%");
                setUI('m-dist-pct', ((distTotal / total) * 100).toFixed(2) + "%");
                setUI('m-subs-pct', ((subsTotal / total) * 100).toFixed(2) + "%");
                setUI('m-tax-pct', ((taxTotal / total) * 100).toFixed(2) + "%");
                setUI('m-uc-pct', ((ucTotal / total) * 100).toFixed(2) + "%");
                setUI('m-fit-pct', (((fitAmt + geaAmt) / total) * 100).toFixed(2) + "%");
            }
        }

        window.onload = () => {
            calculateBill();
            calculateMeralcoBill();
        };
    </script>
</body>

</html>
